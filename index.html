<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>행복은행 ATM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #3182f6; --bg: #f2f4f6; --text: #191f28; --grey: #8b95a1; --white: #ffffff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, sans-serif; background: #e5e8eb; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .atm-container { width: 100%; height: 100%; max-width: 450px; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .screen { flex: 1; display: none; flex-direction: column; padding: 24px; box-sizing: border-box; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 타이틀 & 카드 */
        h2 { font-size: 24px; color: var(--text); margin-bottom: 20px; line-height: 1.4; }
        .card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; }

        /* 입력 디스플레이 */
        .input-display { background: var(--white); padding: 20px; border-radius: 12px; font-size: 20px; font-weight: bold; text-align: center; border: 2px solid var(--primary); min-height: 30px; margin-bottom: 20px; }

        /* 가상 키보드 (한글 자음/모음) */
        .keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; background: #d1d6db; padding: 10px; border-radius: 12px; margin-top: auto; }
        .key { background: var(--white); padding: 12px 0; border-radius: 6px; text-align: center; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .key:active { background: #e5e8eb; transform: scale(0.95); }
        .key.wide { grid-column: span 2; background: #adb5bd; color: white; }
        .key.enter { grid-column: span 2; background: var(--primary); color: white; }

        /* 키패드 (비번용) */
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: auto; }
        .num-key { padding: 20px; font-size: 24px; font-weight: 500; background: var(--white); border-radius: 12px; text-align: center; cursor: pointer; }
        .num-key:active { background: #e5e8eb; }

        /* 영수증 */
        .receipt-box { background: var(--white); border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .barcode { width: 100%; height: 50px; background: repeating-linear-gradient(90deg, #000 0, #000 2px, #fff 2px, #fff 5px); margin-top: 15px; }

        .btn-full { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="atm-container">
    <div id="scr-setup" class="screen active" style="overflow-y: auto;">
        <h2 style="color: var(--primary);">ATM 이벤트 설정</h2>
        <input type="text" id="set-target" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" placeholder="대상자 이름 (예: 김행복)">
        <input type="text" id="set-coupon" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" placeholder="인출 내용 (예: 용돈 5만원)">
        <input type="text" id="set-msg" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" placeholder="하단 멘트">
        <input type="text" id="set-data" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" placeholder="QR/바코드 데이터">
        <select id="set-type" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
            <option value="barcode">바코드형</option><option value="qr">QR코드형</option>
        </select>
        <input type="password" id="set-pw" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" placeholder="비밀번호 4자리">
        <button class="btn-full" onclick="startAtm()">시스템 가동</button>
    </div>

    <div id="scr-main" class="screen">
        <p style="color:var(--primary); font-weight:700;">HAPPY BANK</p>
        <h2>반갑습니다.<br>행복을 인출해 보세요.</h2>
        <div class="card"><div style="color:var(--grey); font-size:14px;">인출 가능 잔액</div><div style="font-size:24px; font-weight:700; margin-top:5px;">∞ 무제한</div></div>
        <button class="btn-full" style="margin-top:20px;" onclick="goStep('name')">인출하기</button>
    </div>

    <div id="scr-name" class="screen">
        <h2>성함을<br>입력해 주세요.</h2>
        <div id="display-name" class="input-display"></div>
        <div class="keyboard">
            <div class="key" onclick="kPress('ㄱ')">ㄱ</div><div class="key" onclick="kPress('ㄴ')">ㄴ</div><div class="key" onclick="kPress('ㄷ')">ㄷ</div><div class="key" onclick="kPress('ㄹ')">ㄹ</div><div class="key" onclick="kPress('ㅁ')">ㅁ</div><div class="key" onclick="kPress('ㅂ')">ㅂ</div><div class="key" onclick="kPress('ㅅ')">ㅅ</div>
            <div class="key" onclick="kPress('ㅇ')">ㅇ</div><div class="key" onclick="kPress('ㅈ')">ㅈ</div><div class="key" onclick="kPress('ㅊ')">ㅊ</div><div class="key" onclick="kPress('ㅋ')">ㅋ</div><div class="key" onclick="kPress('ㅌ')">ㅌ</div><div class="key" onclick="kPress('ㅍ')">ㅍ</div><div class="key" onclick="kPress('ㅎ')">ㅎ</div>
            <div class="key" onclick="kPress('ㅏ')">ㅏ</div><div class="key" onclick="kPress('ㅑ')">ㅑ</div><div class="key" onclick="kPress('ㅓ')">ㅓ</div><div class="key" onclick="kPress('ㅕ')">ㅕ</div><div class="key" onclick="kPress('ㅗ')">ㅗ</div><div class="key" onclick="kPress('ㅛ')">ㅛ</div><div class="key" onclick="kPress('ㅜ')">ㅜ</div>
            <div class="key" onclick="kPress('ㅠ')">ㅠ</div><div class="key" onclick="kPress('ㅡ')">ㅡ</div><div class="key" onclick="kPress('ㅣ')">ㅣ</div><div class="key" onclick="kPress('ㅐ')">ㅐ</div><div class="key" onclick="kPress('ㅔ')">ㅔ</div>
            <div class="key wide" onclick="kReset()">지우기</div>
            <div class="key enter" onclick="kCheck()">확인</div>
        </div>
    </div>

    <div id="scr-pw" class="screen">
        <h2>비밀번호를<br>입력해 주세요.</h2>
        <div style="display:flex; justify-content:center; gap:15px; margin:40px 0;" id="pw-dots">
            <div class="dot" style="width:15px; height:15px; border-radius:50%; background:#d1d6db;"></div>
            <div class="dot" style="width:15px; height:15px; border-radius:50%; background:#d1d6db;"></div>
            <div class="dot" style="width:15px; height:15px; border-radius:50%; background:#d1d6db;"></div>
            <div class="dot" style="width:15px; height:15px; border-radius:50%; background:#d1d6db;"></div>
        </div>
        <div class="numpad">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="num-key" onclick="pPress('${i}')">${i}</div>`);</script>
            <div class="num-key" style="color:var(--grey); font-size:16px;" onclick="pReset()">정정</div>
            <div class="num-key" onclick="pPress('0')">0</div>
            <div class="num-key" style="color:var(--primary); font-size:16px;" onclick="pCheck()">확인</div>
        </div>
    </div>

    <div id="scr-loading" class="screen" style="justify-content:center; align-items:center;">
        <div style="border:4px solid #f2f4f6; border-top:4px solid var(--primary); border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top:20px; font-weight:600;">안전하게 처리 중입니다...</p>
    </div>

    <div id="scr-result" class="screen">
        <div id="capture-area">
            <div class="receipt-box">
                <p style="color:var(--primary); font-weight:700; font-size:12px; margin:0;">RECEIPT</p>
                <h3 style="margin:5px 0 20px 0; font-size:20px; border-bottom:1px solid #f2f4f6; padding-bottom:10px;">행복 거래 명세표</h3>
                <div style="font-size:14px; color:var(--text); line-height:2;">
                    <div style="display:flex; justify-content:space-between;"><span>고객님</span><strong id="res-target"></strong></div>
                    <div style="display:flex; justify-content:space-between;"><span>인출항목</span><strong id="res-coupon"></strong></div>
                </div>
                <p style="text-align:center; margin-top:20px; color:var(--primary); font-weight:bold;" id="res-msg"></p>
                <div id="qrcode" style="display:none; justify-content:center; margin-top:15px;"></div>
                <div id="barcode" class="barcode" style="display:none;"></div>
                <p id="res-code" style="text-align:center; font-family:monospace; font-size:12px; margin-top:10px;"></p>
            </div>
        </div>
        <button class="btn-full" onclick="downloadImg()" style="background:#e5e8eb; color:var(--text); margin-top:20px;">명세표 저장하기</button>
        <button class="btn-full" onclick="location.reload()">닫기</button>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, d) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); o.start(); o.stop(audioCtx.currentTime + d); }
    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'ko-KR'; window.speechSynthesis.speak(m); }

    function show(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('scr-'+id).classList.add('active'); }
    
    function startAtm() {
        if(!document.getElementById('set-target').value) return alert("대상자 이름을 입력하세요.");
        show('main');
        speak("행복은행에 오신 것을 환영합니다.");
    }

    function goStep(s) { beep(800, 0.1); show(s); if(s==='name') speak("성함을 화면 키보드로 입력해 주세요."); }

    // 가상 키보드 로직 (간이 한글 조합 없이 나열식 입력)
    let nameStr = "";
    function kPress(k) { beep(1000, 0.05); nameStr += k; document.getElementById('display-name').innerText = nameStr; }
    function kReset() { nameStr = nameStr.slice(0, -1); document.getElementById('display-name').innerText = nameStr; }
    function kCheck() {
        if(nameStr === document.getElementById('set-target').value) {
            goStep('pw'); speak("비밀번호 4자리를 입력해 주세요.");
        } else {
            speak("성함이 일치하지 않습니다."); alert("입력한 이름이 설정과 다릅니다.");
        }
    }

    // 비밀번호 로직
    let pwStr = "";
    function pPress(n) {
        if(pwStr.length < 4) {
            pwStr += n; beep(1100, 0.05);
            const ds = document.querySelectorAll('.dot');
            ds[pwStr.length-1].style.background = "var(--primary)";
        }
    }
    function pReset() { pwStr = ""; document.querySelectorAll('.dot').forEach(d => d.style.background = "#d1d6db"); }
    function pCheck() {
        const correct = document.getElementById('set-pw').value;
        if(correct && pwStr !== correct) { speak("비밀번호가 틀렸습니다."); pReset(); }
        else {
            speak("잠시만 기다려 주세요."); show('loading');
            setTimeout(finish, 3000);
        }
    }

    function finish() {
        document.getElementById('res-target').innerText = document.getElementById('set-target').value;
        document.getElementById('res-coupon').innerText = document.getElementById('set-coupon').value;
        document.getElementById('res-msg').innerText = `"${document.getElementById('set-msg').value}"`;
        const d = document.getElementById('set-data').value || "HAPPY-GIFT";
        document.getElementById('res-code').innerText = d;
        if(document.getElementById('set-type').value === 'qr') {
            document.getElementById('qrcode').style.display='flex'; document.getElementById('qrcode').innerHTML="";
            new QRCode(document.getElementById("qrcode"), { text: d, width: 120, height: 120 });
        } else { document.getElementById('barcode').style.display='block'; }
        show('result'); speak("인출이 완료되었습니다. 명세표를 저장해 보세요.");
    }

    function downloadImg() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const a = document.createElement('a'); a.download = '행복명세표.png'; a.href = canvas.toDataURL(); a.click();
        });
    }
</script>
</body>
</html>
